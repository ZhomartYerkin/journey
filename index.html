<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Journey — Map</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    :root{
      --bg:#0b0d12;--fg:#e7ecf3;--muted:#9aa4b2;--acc:#4f8cff;--green:#1fc77e;--yellow:#ffd166;--card:#121622;--border:#1d2230;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .app{display:grid;grid-template-rows:auto 1fr;height:100%}
    header{display:flex;gap:.75rem;align-items:center;padding:.75rem 1rem;background:linear-gradient(180deg,#0e1220,#0b0d12);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:1000}
    .title{font-weight:700;letter-spacing:.2px;margin-right:auto}
    .toolbar{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    button,select{appearance:none;border:1px solid var(--border);background:var(--card);color:var(--fg);padding:.5rem .75rem;border-radius:.75rem;cursor:pointer;transition:transform .04s ease,border-color .2s ease,background .2s ease}
    button:hover,select:hover{border-color:#2a3347}
    button:active{transform:translateY(1px)}
    button.active{outline:2px solid var(--acc);background:#10172a}
    .chip{font-weight:600}
    .chip.lived{color:var(--green)}
    .chip.visited{color:var(--yellow)}
    #map{height:calc(100dvh - 64px);width:100%}
    .leaflet-popup-content-wrapper{background:var(--card);color:var(--fg);border:1px solid var(--border)}
    .leaflet-popup-tip{background:var(--card)}
    .attribution{position:fixed;right:10px;bottom:10px;font-size:12px;color:var(--muted)}
    a{color:var(--acc);text-decoration:none}
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="title">Journey</div>
    <div class="toolbar">
      <button id="toggleLived"><span class="chip lived">●</span> <span data-i18n="lived">Жил</span></button>
      <button id="toggleVisited"><span class="chip visited">●</span> <span data-i18n="visited">Посетил</span></button>
      <button id="resetBtn" title="Сброс вида/состояния"><span data-i18n="reset">Сброс</span></button>
      <select id="langSelect" aria-label="Language">
        <option value="ru">RU</option>
        <option value="en">EN</option>
      </select>
    </div>
  </header>
  <div id="map" role="region" aria-label="Journey map"></div>
</div>
<div class="attribution">
  © <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener">OSM contributors</a>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
/* =========================
   i18n
========================= */
const I18N = {
  en: { lived:"Lived", visited:"Visited", reset:"Reset", popup_lived:"Lived here", popup_visited:"Visited" },
  ru: { lived:"Жил",  visited:"Посетил", reset:"Сброс", popup_lived:"Здесь жил", popup_visited:"Посещал" }
};
const LS_KEYS = { lang:'journey:lang', showLived:'journey:showLived', showVisited:'journey:showVisited', mapState:'journey:mapState' };

/* =========================
   DATA via fetch
========================= */
async function loadData(){
  const res = await fetch('data/places.json', { cache: 'no-cache' });
  if(!res.ok) throw new Error('Не удалось загрузить data/places.json');
  const json = await res.json();
  // нормализуем поля (на случай пропусков)
  return {
    lived: (json.lived||[]).map(n => ({ name:n.name, coords:n.coords, years:n.years||"", notes:n.notes||"" })),
    visited: (json.visited||[]).map(n => ({ name:n.name, coords:n.coords, years:n.years||"", notes:n.notes||"" })),
  };
}
let livedPlaces = [];
let visitedPlaces = [];

/* =========================
   Map init
========================= */
const map = L.map('map', { worldCopyJump:true, zoomSnap:.5 });
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'' }).addTo(map);

const livedLayer = L.layerGroup();
const visitedLayer = L.layerGroup();

function markerIcon(kind){
  const color = (kind==='lived') ? '#1fc77e' : '#ffd166';
  return L.divIcon({
    className:'custom-marker',
    html:`<span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:${color};border:2px solid #0006;box-shadow:0 2px 6px rgba(0,0,0,.35)"></span>`,
    iconSize:[12,12], iconAnchor:[6,6]
  });
}
function popupHtml(p, kind){
  const t = I18N[currentLang()];
  const label = (kind==='lived') ? t.popup_lived : t.popup_visited;
  const years = p.years ? `<div style="opacity:.8">${p.years}</div>` : '';
  const notes = p.notes ? `<div style="margin-top:.25rem">${p.notes}</div>` : '';
  return `<div style="min-width:180px"><div style="font-weight:700">${p.name}</div><div style="font-size:12px;opacity:.85">${label}</div>${years}${notes}</div>`;
}
function addPoints(){
  livedLayer.clearLayers(); visitedLayer.clearLayers();
  livedPlaces.forEach(p => L.marker(p.coords,{icon:markerIcon('lived')}).bindPopup(()=>popupHtml(p,'lived')).addTo(livedLayer));
  visitedPlaces.forEach(p => L.marker(p.coords,{icon:markerIcon('visited')}).bindPopup(()=>popupHtml(p,'visited')).addTo(visitedLayer));
}

/* =========================
   Fit bounds
========================= */
function fitAll(){
  const group = L.featureGroup([livedLayer, visitedLayer]);
  const b = group.getBounds();
  if (b.isValid()) map.fitBounds(b.pad(0.2)); else map.setView([20,0],2);
}

/* =========================
   UI state & i18n
========================= */
function currentLang(){
  const hashLang = new URLSearchParams(location.hash.slice(1)).get('lang');
  return hashLang || (localStorage.getItem(LS_KEYS.lang) || 'ru');
}
function setLang(lang){
  localStorage.setItem(LS_KEYS.lang, lang);
  const sp = new URLSearchParams(location.hash.slice(1)); sp.set('lang', lang); location.hash = sp.toString();
  applyI18n();
}
function applyI18n(){
  const lang = currentLang();
  document.documentElement.lang = lang;
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n'); el.textContent = I18N[lang][key];
  });
}
function setButtonActive(btn, on){ btn.classList.toggle('active', !!on); }

/* =========================
   Controls
========================= */
const langSelect = document.getElementById('langSelect');
const btnLived = document.getElementById('toggleLived');
const btnVisited = document.getElementById('toggleVisited');
const btnReset = document.getElementById('resetBtn');

function initControls(){
  // язык
  langSelect.value = currentLang();
  applyI18n();
  langSelect.addEventListener('change', e => setLang(e.target.value));
  window.addEventListener('hashchange', applyI18n);

  // слои
  const savedShowLived = localStorage.getItem(LS_KEYS.showLived);
  const savedShowVisited = localStorage.getItem(LS_KEYS.showVisited);
  const showLived = savedShowLived===null ? true : savedShowLived==='1';
  const showVisited = savedShowVisited===null ? true : savedShowVisited==='1';

  if (showLived) map.addLayer(livedLayer);
  if (showVisited) map.addLayer(visitedLayer);
  setButtonActive(btnLived, showLived);
  setButtonActive(btnVisited, showVisited);

  btnLived.addEventListener('click', ()=>{
    if (map.hasLayer(livedLayer)) { map.removeLayer(livedLayer); localStorage.setItem(LS_KEYS.showLived,'0'); setButtonActive(btnLived,false); }
    else { map.addLayer(livedLayer); localStorage.setItem(LS_KEYS.showLived,'1'); setButtonActive(btnLived,true); }
  });
  btnVisited.addEventListener('click', ()=>{
    if (map.hasLayer(visitedLayer)) { map.removeLayer(visitedLayer); localStorage.setItem(LS_KEYS.showVisited,'0'); setButtonActive(btnVisited,false); }
    else { map.addLayer(visitedLayer); localStorage.setItem(LS_KEYS.showVisited,'1'); setButtonActive(btnVisited,true); }
  });
  btnReset.addEventListener('click', ()=>{
    if (!map.hasLayer(livedLayer)) map.addLayer(livedLayer);
    if (!map.hasLayer(visitedLayer)) map.addLayer(visitedLayer);
    localStorage.setItem(LS_KEYS.showLived,'1');
    localStorage.setItem(LS_KEYS.showVisited,'1');
    setButtonActive(btnLived,true); setButtonActive(btnVisited,true);
    localStorage.removeItem(LS_KEYS.mapState);
    fitAll();
  });
}

/* =========================
   Persist map view
========================= */
function saveMapState(){
  const c = map.getCenter(); const z = map.getZoom();
  localStorage.setItem(LS_KEYS.mapState, JSON.stringify({ lat:c.lat, lng:c.lng, zoom:z }));
}
function restoreMapState(){
  const raw = localStorage.getItem(LS_KEYS.mapState); if(!raw) return false;
  try{
    const s = JSON.parse(raw);
    if (typeof s.lat==='number' && typeof s.lng==='number' && typeof s.zoom==='number'){ map.setView([s.lat,s.lng], s.zoom); return true; }
  }catch{}
  return false;
}
map.on('moveend', saveMapState);
map.on('zoomend', saveMapState);

/* =========================
   Boot: загрузка данных
========================= */
(async function boot(){
  try{
    const data = await loadData();
    livedPlaces = data.lived;
    visitedPlaces = data.visited;
    addPoints();
    initControls();
    if (!restoreMapState()) fitAll();
  }catch(err){
    console.error(err);
    alert('Ошибка загрузки данных: ' + err.message);
    // даже если данных нет — инициализируем базовые контролы
    initControls();
    map.setView([20,0],2);
  }
})();
</script>
</body>
</html>

